<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pay with Saved Token | APS</title>
  <style>
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto; background:#0f172a; color:#e2e8f0; min-height:100vh; display:flex; justify-content:center; }
    .wrap{ width:100%; max-width:420px; background:#111827; padding:24px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); margin:20px; }
    h1{ margin:0 0 12px; font-size:20px; text-align:center }
    label{ display:block; font-size:13px; color:#94a3b8; margin-bottom:6px }
    input,select{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e2e8f0; margin-bottom:16px }
    button{ width:100%; padding:12px 14px; border-radius:10px; background:#2563eb; color:#fff; border:0; cursor:pointer; font-weight:600; transition:opacity .2s, transform .05s; }
    button:disabled{ opacity:.6; cursor:not-allowed }
    button:active{ transform: translateY(1px); }
    .err,.ok{ margin-top:12px; padding:10px 12px; border-radius:10px; display:none; font-size:13px }
    .err{ background:#7f1d1d; color:#fecaca }
    .ok{ background:#0b3d17; color:#c7f9cc }
    pre{ background:#0b1020; color:#d1d5db; padding:10px; border-radius:10px; overflow:auto }
    .muted{ color:#94a3b8; text-align:center; margin-bottom:16px }
    .spin{ width:16px;height:16px;border-radius:50%; border:2px solid rgba(255,255,255,.4); border-top-color:#fff; display:inline-block; vertical-align:-3px; margin-right:8px; animation:spin 0.8s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg); } }
    .debug{ display:none; }
    body.debug .debug{ display:block; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Repeat Purchase</h1>

    <label>Merchant Reference</label>
    <input id="mref" placeholder="ORD-{{timestamp}}" />

    <label>Amount</label>
    <input id="amount" type="number" step="0.01" min="0" placeholder="50.00" />

    <label>Currency</label>
    <select id="currency">
      <option value="SAR">SAR</option>
      <option value="AED">AED</option>
      <option value="USD">USD</option>
      <option value="JOD">JOD</option>
      <option value="KWD">KWD</option>
      <option value="BHD">BHD</option>
      <option value="OMR">OMR</option>
      <option value="TND">TND</option>
    </select>

    <label>Language</label>
    <select id="language">
      <option value="en">English</option>
      <option value="ar">Arabic</option>
    </select>

    <label>Customer Email</label>
    <input id="email" placeholder="example@site.com" />

    <label>Card Security Code (CVV)</label>
    <input id="cvv" type="password" maxlength="4" placeholder="123" />

    <button id="pay">Pay Now</button>

    <div id="ok" class="ok"></div>
    <div id="err" class="err"></div>

    <!-- Gateway Response يظهر فقط إذا فعلت وضع debug -->
    <div class="debug" style="margin-top:12px">
      <label class="muted">Gateway Response</label>
      <pre id="result">{}</pre>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);

function decimalsForCurrency(c){
  c = (c||"").toUpperCase();
  const three = new Set(["JOD","KWD","BHD","OMR","TND","LYD","IQD"]);
  return three.has(c) ? 3 : 2;
}
function toMinor(amountStr, currency){
  const d = decimalsForCurrency(currency);
  const val = Number(amountStr);
  if(!isFinite(val) || val < 0) return null;
  const factor = Math.pow(10, d);
  return Math.round(val * factor);
}

function setBtnLoading(btn, loading){
  if(loading){
    btn.dataset._label = btn.textContent;
    btn.innerHTML = '<span class="spin"></span> Processing...';
    btn.disabled = true;
  }else{
    btn.innerHTML = btn.dataset._label || 'Pay Now';
    btn.disabled = false;
  }
}

window.addEventListener('load',()=>{
  const email = localStorage.getItem('APS_EMAIL');
  if(email) $('email').value = email;
});

$('pay').addEventListener('click', async ()=>{
  const email = $('email').value.trim();
  const amount = $('amount').value.trim();
  const currency = $('currency').value;
  const language = $('language').value || 'en';
  const merchant_reference = $('mref').value.trim() || ('ORD-'+Date.now());
  const cvv = $('cvv').value.trim();
  const okBox = $('ok'), errBox = $('err');
  const btn = $('pay');
  const resultBox = $('result');

  okBox.style.display=errBox.style.display='none';
  okBox.textContent=errBox.textContent='';
  resultBox.textContent = '{}';

  if(!email){
    errBox.textContent='Email is required';
    errBox.style.display='block';
    return;
  }
  if(!cvv){
    errBox.textContent='CVV is required';
    errBox.style.display='block';
    return;
  }
  const minor = toMinor(amount, currency);
  if(minor===null){
    errBox.textContent='Enter a valid amount';
    errBox.style.display='block';
    return;
  }

  try{ localStorage.setItem('APS_EMAIL', email); }catch(e){}

  setBtnLoading(btn, true);

  try{
    const res = await fetch('http://localhost:8290/aps/payment-existing', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        merchant_reference,
        amount:String(minor),
        currency,
        language,
        customer_email: email,
        card_security_code: cvv
      })
    });

    const text = await res.text();
    let j;
    try{ j = JSON.parse(text); }catch{ j = { raw: text }; }

    resultBox.textContent = JSON.stringify(j, null, 2);

    const ok = j && (j.status === 'SUCCESS' || j.status === '14' || (String(j.response_code||'').startsWith('20')));
    if(ok){
      okBox.textContent='Purchase completed ✅';
      okBox.style.display='block';
    }else{
      errBox.textContent='Purchase failed ❌';
      errBox.style.display='block';
    }
  }catch(ex){
    errBox.textContent = 'Network error: ' + ex.message;
    errBox.style.display='block';
  }finally{
    setBtnLoading(btn, false);
  }
});
</script>
</body>
</html>
