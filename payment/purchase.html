<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#2563eb; --bg:#0f172a; --card:#111827; --text:#e2e8f0; --muted:#94a3b8; --danger:#7f1d1d; --danger-text:#fecaca; --success:#0b3d17; --success-text:#c7f9cc; --radius:16px; --gap:16px; }
    body { margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto; background:var(--bg); color:var(--text); display:grid; place-items:center; min-height:100vh; padding:0; }
    .wrap { width:min(480px, 96vw); background:var(--card); padding:32px; border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.35); display:flex; flex-direction:column; align-items:flex-start; gap:var(--gap); }
    h1 { margin:0; font-size:24px; font-weight:700; text-align:left; }
    h3 { margin:var(--gap) 0 8px; font-size:18px; font-weight:600; text-align:left; }
    .muted { color:var(--muted); font-size:14px; text-align:left; }
    label { display:block; font-size:14px; color:var(--muted); margin-bottom:6px; text-align:left; }
    input,select { width:100%; padding:12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:var(--text); text-align:left; }
    button { padding:14px 32px; border-radius:10px; background:var(--primary); color:#fff; border:0; cursor:pointer; font-weight:700; transition:background .2s; margin-top:12px; width:auto; font-size:16px; }
    button:hover { background:#1e40af; }
    .err,.ok { padding:12px; border-radius:10px; display:none; font-size:14px; text-align:left; }
    .err { background:var(--danger); color:var(--danger-text) }
    .ok { background:var(--success); color:var(--success-text) }
    hr { margin:16px 0; border:0; border-top:1px solid #334155 }
    .hint { font-size:13px; color:var(--muted); text-align:left; }
    .pay-wrapper { display:flex; justify-content:flex-start; width:100%; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>First Purchase </h1>

    <label>Email</label>
    <input id="email" placeholder="example@site.com" />

    <label>Merchant Reference</label>
    <input id="mref" placeholder="ORD-{{timestamp}}" />

    <label>Amount</label>
    <input id="amount" type="number" step="0.01" min="0" placeholder="100.00" />

    <label>Currency</label>
    <select id="currency">
      <option value="SAR">SAR</option>
      <option value="AED">AED</option>
      <option value="USD">USD</option>
      <option value="JOD">JOD</option>
      <option value="KWD">KWD</option>
      <option value="BHD">BHD</option>
      <option value="OMR">OMR</option>
      <option value="TND">TND</option>
    </select>

    <label>Language</label>
    <select id="language">
      <option value="en">English</option>
      <option value="ar">Arabic</option>
    </select>

    <button id="gen" type="button">Generate Reference</button>

    <hr />

    <h3>Card Details</h3>
    <label>Card Number</label>
    <input id="card_number" inputmode="numeric" autocomplete="cc-number" placeholder="4111111111111111" />

    <label>Cardholder Name (optional)</label>
    <input id="card_holder_name" autocomplete="cc-name" placeholder="Name on card" />

    <label>Expiry Month (MM)</label>
    <input id="exp_mm" inputmode="numeric" maxlength="2" placeholder="MM" />

    <label>Expiry Year (YY)</label>
    <input id="exp_yy" inputmode="numeric" maxlength="2" placeholder="YY" />

    <label>CVV</label>
    <input id="cvv" inputmode="numeric" maxlength="4" placeholder="CVV" />

    <div class="hint">A new window will open for tokenization. The server will finalize the payment after APS redirects to <code>/aps/token-callback</code>.</div>

    <div id="ok" class="ok"></div>
    <div id="err" class="err"></div>

    <div class="remember-text" style="align-self:flex-start;margin:16px 0 6px 0; text-align:left; color:var(--muted); font-size:14px">Remember this card for later use</div>
    <div class="remember-checkbox" style="align-self:flex-start; display:flex; align-items:center; gap:6px">
      <input id="remember_me" type="checkbox" style="margin:0" />
      <span id="remember_state" class="muted"></span>
    </div>

    <div class="pay-wrapper">
      <button id="pay" type="button">Pay Now</button>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);

function decimalsForCurrency(c){ c=(c||"").toUpperCase(); const three = new Set(["JOD","KWD","BHD","OMR","TND","LYD","IQD"]); return three.has(c) ? 3 : 2; }
function toMinor(amountStr, currency){ const d = decimalsForCurrency(currency); const val = Number(amountStr); if(!isFinite(val) || val < 0) return null; const factor = Math.pow(10, d); return Math.round(val * factor); }
function sanitizeDigits(s){ return String(s||"").replace(/\D+/g,""); }

(function initRemember(){
  try{
    const saved = localStorage.getItem('APS_REMEMBER') === 'YES';
    const cb = $('remember_me');
    const state = $('remember_state');
    if(cb){ cb.checked = saved; }
    if(state){ state.textContent = saved ? '(will be remembered)' : ''; }
    if(cb){
      cb.addEventListener('change', ()=>{
        const on = cb.checked;
        localStorage.setItem('APS_REMEMBER', on ? 'YES' : 'NO');
        if(state) state.textContent = on ? '(will be remembered)' : '';
      });
    }
  }catch(_){ /* ignore */ }
})();

window.addEventListener('load',()=>{
  const email = localStorage.getItem('APS_EMAIL'); if(email) $('email').value = email;
});
$('gen').onclick = ()=>{ $('mref').value = 'ORD-'+Date.now(); };

window.addEventListener('message',(ev)=>{
  try{
    const payload = ev.data && ev.data.type==='APS_CALLBACK' ? ev.data.data : null;
    if(!payload) return;
    if(payload.signature_ok && payload.token_name){
      localStorage.setItem('APS_TOKEN', payload.token_name);
      showOk('Token saved. The server is completing your purchase in the opened window.');
    }else{ showErr('Tokenization failed or signature mismatch.'); }
  }catch(_){ }
});

function showOk(t){ const el=$('ok'); el.textContent=t; el.style.display='block'; $('err').style.display='none'; }
function showErr(t){ const el=$('err'); el.textContent=t; el.style.display='block'; $('ok').style.display='none'; }

$('pay').addEventListener('click', async ()=>{
  const email = $('email').value.trim();
  const amount = $('amount').value.trim();
  const currency = $('currency').value;
  const language = $('language').value || 'en';
  const merchant_reference = $('mref').value.trim() || ('ORD-'+Date.now());

  const card_number = sanitizeDigits($('card_number').value);
  const exp_mm = sanitizeDigits($('exp_mm').value).padStart(2,'0').slice(-2);
  const exp_yy = sanitizeDigits($('exp_yy').value).padStart(2,'0').slice(-2);
  const expiry_date = exp_yy + exp_mm;
  const card_security_code = sanitizeDigits($('cvv').value);
  const card_holder_name = $('card_holder_name').value.trim();
  const remember_me = $('remember_me').checked ? 'YES' : 'NO';

  $('ok').style.display=$('err').style.display='none';

  if(!email){ showErr('Email is required'); return; }
  if(!card_number || !expiry_date || !card_security_code){ showErr('Complete card details'); return; }
  localStorage.setItem('APS_EMAIL', email);
  localStorage.setItem('APS_REMEMBER', remember_me);

  const minor = toMinor(amount, currency);
  if(minor===null){ showErr('Enter a valid amount'); return; }

  let prep;
  try{
    const res = await fetch("http://localhost:8290/aps/prepare-token", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        merchant_reference,
        language,
        amount: String(minor),
        currency,
        customer_email: email
      })
    });
    prep = await res.json();
    if(!res.ok || !prep || !prep.gateway_url || !prep.params || !prep.params.signature){
      showErr('Unexpected server response'); console.error(prep); return;
    }
  }catch(ex){ showErr('Network error: '+ex.message); return; }

  const f = document.createElement('form');
  f.method = 'POST';
  f.action = prep.gateway_url;
  f.target = '_blank';
  f.acceptCharset = 'UTF-8';

  for(const [k,v] of Object.entries(prep.params)){
    if(v==null || v==='') continue;
    const i=document.createElement('input');
    i.type='hidden'; i.name=k; i.value=String(v);
    f.appendChild(i);
  }

  const add=(k,v)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=k; i.value=v; f.appendChild(i); };
  add('card_number', card_number);
  add('expiry_date', expiry_date);
  add('card_security_code', card_security_code);
  if(card_holder_name) add('card_holder_name', card_holder_name);
  if(remember_me==='YES') add('remember_me', 'YES');

  document.body.appendChild(f);
  showOk('Submitting to APS for tokenization...');
  f.submit();
});
</script>
</body>
</html>
